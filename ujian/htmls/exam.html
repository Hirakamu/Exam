<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ujian — SMAN 2 Cikarang Pusat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="robots" content="noindex">
    <style>
        /* small helper styles */
        .option-btn {
            transition: all .12s;
        }

        .option-btn:hover {
            transform: translateY(-2px);
        }

        .disabled {
            opacity: .6;
            pointer-events: none;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 font-sans">
    <div class="max-w-4xl mx-auto px-4 py-8">
        <header class="text-center mb-6">
            <h1 id="pageHeader" class="text-2xl font-bold">Ujian — SMAN 2 Cikarang Pusat</h1>
            <p class="text-sm text-gray-600">Pastikan Anda berada di ruang yang benar. Prototype.</p>
        </header>

        <main class="space-y-6">
            <!-- Pre-exam burn-in: show rules / agreement inline before starting -->
            <div id="preExamBurn" class="bg-white border rounded-lg shadow-sm p-6 w-full">
                <div>
                    <h2 class="text-xl font-semibold mb-2">Tata Tertib dan Ketentuan Ujian</h2>
                    <p class="text-sm text-gray-600 mb-3">Baca dengan teliti sebelum memulai ujian. Anda harus menyetujui ketentuan ini untuk dapat melanjutkan.</p>
                    <div class="text-sm text-gray-800 mb-3">
                        <ul class="list-disc ml-5 space-y-1">
                            <li>Pastikan koneksi internet stabil selama ujian.</li>
                            <li>Tidak menggunakan bantuan orang lain atau bahan yang dilarang.</li>
                            <li>Jawaban yang dikumpulkan setelah waktu habis mungkin tidak dinilai.</li>
                            <li>Segala bentuk kecurangan akan berakibat pada pembatalan nilai.</li>
                            <li>Dengan menekan "Mengerti dan Berkomitmen" Anda menyetujui tata tertib dan menyerahkan pernyataan kejujuran.</li>
                        </ul>
                    </div>
                    <div class="mt-4 flex items-center gap-3">
                        <input id="agreeCheckbox" type="checkbox" class="w-4 h-4" />
                        <label for="agreeCheckbox" class="text-sm text-gray-700">Saya mengerti dan berkomitmen mematuhi tata tertib ujian.</label>
                    </div>
                    <div class="mt-6 text-right">
                        <button id="continueBtn" class="px-4 py-2 bg-blue-600 text-white rounded disabled:opacity-60" disabled>Teruskan dan mulai ujian</button>
                    </div>
                    <div class="mt-3 text-xs text-gray-500">Jika koneksi ke server gagal, ujian akan tetap dimulai secara lokal dan jawaban akan tetap tersimpan di browser hingga berhasil dikirim.</div>
                </div>
            </div>
            <!-- Full-width exam area: render all questions stacked vertically (hidden until user accepts) -->
            <section id="examArea" class="bg-white border rounded-lg shadow-sm p-6" style="display:none;">
                <div class="mb-4">
                    <div id="examTitle" class="text-lg font-semibold">Contoh Ujian</div>
                    <div id="meta" class="text-sm text-gray-500">Kelas: <span id="examClass">-</span> • Soal: <span
                            id="totalQuestions">0</span></div>
                    <div class="mt-3 w-full h-3 bg-gray-100 rounded overflow-hidden"></div>
                </div>

                <div id="questionContainer" class="space-y-4">
                    <!-- all questions will be rendered here stacked downward -->
                </div>

                <div class="mt-6 text-right">
                    <button id="finishBtn"
                        class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">Finish</button>
                </div>
            </section>
        </main>

        <footer class="text-center mt-8 text-sm text-gray-500">
            <div>Hak Cipta © 2025 SMAN 2 Cikarang Pusat</div>
            <div>Karya Siswa Kelas 11</div>
        </footer>
    </div>

    <script>
        // Exam JSON sample (from examtmp.json)
        const EXAM_JSON = {
            "form": "Bahasa Indonesia",
            "kelas": "X",
            "semester": 1,
            "tahun": "2025/2026",
            "field": [
                {
                    "id": 1,
                    "pertanyaan": "qwe",
                    "jawab": {
                        "tipe": "PG",
                        "opsi": [
                            {
                                "id": 1,
                                "text": "asd"
                            },
                            {
                                "id": 2,
                                "text": "fgh"
                            },
                            {
                                "id": 3,
                                "text": "jkl"
                            },
                            {
                                "id": 4,
                                "text": "zxc"
                            }
                        ]
                    }
                },
                {
                    "id": 2,
                    "pertanyaan": "rty",
                    "jawab": {
                        "tipe": "MCMA",
                        "opsi": [
                            {
                                "id": 1,
                                "text": "asd"
                            },
                            {
                                "id": 2,
                                "text": "fgh"
                            },
                            {
                                "id": 3,
                                "text": "jkl"
                            },
                            {
                                "id": 4,
                                "text": "zxc"
                            }
                        ]
                    }
                },
                {
                    "id": 3,
                    "pertanyaan": "uio",
                    "jawab": {
                        "tipe": "TF"
                    }
                }
            ]
        };

        // Use EXAM_JSON as the sample source
        document.getElementById('examTitle').textContent = EXAM_JSON.form + ' — ' + (EXAM_JSON.tahun || '');
        document.getElementById('examClass').textContent = EXAM_JSON.kelas || '-';
        // Set top page header to exam subject
        const pageHeader = document.getElementById('pageHeader');
        if (pageHeader) pageHeader.textContent = EXAM_JSON.form;
        const totalQuestions = EXAM_JSON.field.length;
        document.getElementById('totalQuestions').textContent = totalQuestions;

        const answers = {}; // question id -> selected value(s)

        function escapeHtml(s) { return String(s).replace(/[&<>\"]+/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '\"': '&quot;' }[c] || c)); }

        function renderAllQuestions() {
            const container = document.getElementById('questionContainer');
            container.innerHTML = '';
            EXAM_JSON.field.forEach((f, idx) => {
                const qid = String(f.id);
                const qBlock = document.createElement('div');
                qBlock.dataset.qid = qid;
                qBlock.className = 'border rounded-lg p-4 bg-white shadow-sm';

                const qHead = document.createElement('div');
                qHead.className = 'mb-2 flex items-center justify-between gap-2';

                const title = document.createElement('div');
                title.className = 'font-medium';
                title.innerHTML = `<span class="inline-block w-6">${idx + 1}.</span> ${escapeHtml(f.pertanyaan)}`;

                const headRight = document.createElement('div');
                headRight.className = 'flex items-center gap-2';
                const type = document.createElement('div');
                type.className = 'text-sm text-gray-500';
                type.textContent = (f.jawab && f.jawab.tipe) ? f.jawab.tipe : 'PG';

                headRight.appendChild(type);

                qHead.appendChild(title);
                qHead.appendChild(headRight);
                qBlock.appendChild(qHead);

                const opts = document.createElement('div');
                opts.className = 'space-y-2';

                const tipe = (f.jawab && f.jawab.tipe) ? f.jawab.tipe.toUpperCase() : 'PG';

                if (tipe === 'PG') {
                    (f.jawab.opsi || []).forEach(opt => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'option-btn w-full text-left px-4 py-3 border rounded-lg bg-gray-50 hover:bg-gray-100';
                        btn.innerHTML = `<span class="inline-block w-6">${escapeHtml(String(opt.id))}.</span> ${escapeHtml(opt.text)}`;
                        btn.onclick = () => { answers[qid] = opt.id; renderAllQuestions(); };
                        if (answers[qid] === opt.id) btn.classList.add('bg-blue-50', 'border-blue-300');
                        opts.appendChild(btn);
                    });
                } else if (tipe === 'MCMA') {
                    (f.jawab.opsi || []).forEach(opt => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'option-btn w-full text-left px-4 py-3 border rounded-lg bg-gray-50 hover:bg-gray-100 flex items-center gap-3';
                        // checkbox box: use inline-flex so the checkmark is centered
                        const checkbox = document.createElement('span');
                        checkbox.className = 'w-4 h-4 inline-flex items-center justify-center border rounded-sm text-xs text-blue-600';
                        const label = document.createElement('span');
                        label.innerHTML = `${escapeHtml(opt.text)}`;
                        btn.appendChild(checkbox);
                        btn.appendChild(label);
                        btn.onclick = () => {
                            answers[qid] = answers[qid] || [];
                            const idxSel = answers[qid].indexOf(opt.id);
                            if (idxSel === -1) answers[qid].push(opt.id); else answers[qid].splice(idxSel, 1);
                            renderAllQuestions();
                        };
                        const selectedArr = answers[qid] || [];
                        if (selectedArr.indexOf(opt.id) !== -1) { btn.classList.add('bg-blue-50', 'border-blue-300'); checkbox.textContent = '✓'; } else { checkbox.textContent = ''; }
                        opts.appendChild(btn);
                    });
                } else if (tipe === 'TF') {
                    ['Benar', 'Salah'].forEach(val => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'option-btn w-full text-left px-4 py-3 border rounded-lg bg-gray-50 hover:bg-gray-100';
                        btn.textContent = val;
                        btn.onclick = () => { answers[qid] = val; renderAllQuestions(); };
                        if (answers[qid] === val) btn.classList.add('bg-blue-50', 'border-blue-300');
                        opts.appendChild(btn);
                    });
                } else {
                    // fallback: render opsi if available
                    (f.jawab && f.jawab.opsi || []).forEach(opt => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'option-btn w-full text-left px-4 py-3 border rounded-lg bg-gray-50 hover:bg-gray-100';
                        btn.innerHTML = `${escapeHtml(opt.text)}`;
                        btn.onclick = () => { answers[qid] = opt.id || opt.text; renderAllQuestions(); };
                        if (answers[qid] === (opt.id || opt.text)) btn.classList.add('bg-blue-50', 'border-blue-300');
                        opts.appendChild(btn);
                    });
                }

                qBlock.appendChild(opts);
                container.appendChild(qBlock);
            });
        }

        function updateProgress() { /* no-op; progressFill removed */ }

        function finishExam() {
            if (!confirm('Anda yakin ingin mengakhiri ujian dan mengumpulkan jawaban?')) return;
            doFinish();
        }

        function doFinish() {
            const result = {
                meta: { form: EXAM_JSON.form, kelas: EXAM_JSON.kelas, tahun: EXAM_JSON.tahun, takenAt: new Date().toISOString() },
                responses: answers
            };
            // Replace the exam form with a 'wait for proctor' message and include a small summary for the user
            const area = document.getElementById('examArea');
            if (area) {
                area.innerHTML = `
                    <div class="p-6 text-center">
                        <h2 class="text-xl font-semibold mb-2">Ujian telah selesai</h2>
                        <p class="mb-3">Terima kasih. Jawaban Anda telah disimpan.</p>
                        <p class="mb-4 font-medium">Silakan tunggu instruksi dari pengawas.</p>
                        <div class="text-left bg-gray-100 p-3 rounded text-sm overflow-auto">
                            <strong>Ringkasan jawaban (local):</strong>
                            <pre class="mt-2">${escapeHtml(JSON.stringify(result, null, 2))}</pre>
                        </div>
                    </div>
                `;
            }
            // Optionally: send final result to server (async, best-effort). This does not block the UI.
            (async () => {
                try {
                    await fetch('/api/exam/submit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(result)
                    });
                } catch (err) {
                    console.warn('Failed to POST exam submission (will remain local):', err);
                }
            })();
        }

        document.getElementById('finishBtn').addEventListener('click', finishExam);

        // Pre-exam flow: require user agreement before rendering questions
    const preExamBurn = document.getElementById('preExamBurn');
        const agreeCheckbox = document.getElementById('agreeCheckbox');
        const continueBtn = document.getElementById('continueBtn');

        // ensure checkbox is explicitly unchecked on load (prevent browser form-state restore)
        try {
            agreeCheckbox.checked = false;
        } catch (e) { /* ignore if element missing */ }
        // ensure continue button is disabled initially
        if (continueBtn) continueBtn.disabled = true;

        // enable/disable continue based on checkbox
        agreeCheckbox.addEventListener('change', () => {
            continueBtn.disabled = !agreeCheckbox.checked;
        });

        // startExam: POST acceptance to server and then render questions
        async function startExam() {
            continueBtn.disabled = true;
            continueBtn.textContent = 'Memulai...';
            const payload = {
                meta: { form: EXAM_JSON.form, kelas: EXAM_JSON.kelas, tahun: EXAM_JSON.tahun },
                agreed: true,
                agreedAt: new Date().toISOString()
            };

            // Attempt to POST to a reasonable endpoint. If it fails, proceed locally.
            try {
                const resp = await fetch('/api/exam/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!resp.ok) {
                    console.warn('Server returned non-OK response for exam start:', resp.status);
                } else {
                    console.log('Exam start acknowledged by server');
                }
            } catch (err) {
                console.warn('Could not contact server for exam start, starting locally.', err);
            }

            // replace the pre-exam burn-in element with the exam form (keeps document flow)
            const examArea = document.getElementById('examArea');
            if (preExamBurn && examArea) {
                // ensure questions render before we attach so user sees them immediately
                renderAllQuestions();
                // show the exam area and replace the burn-in element in-place
                examArea.style.display = '';
                preExamBurn.replaceWith(examArea);
            } else {
                // fallback: render in-place if replacement not possible
                renderAllQuestions();
                if (examArea) examArea.style.display = '';
            }
        }

        continueBtn.addEventListener('click', startExam);

        // show modal on load (modal is already present), don't render until accepted

    </script>
</body>

</html>