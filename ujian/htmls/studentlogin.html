<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Ujian SMAN 2 Cikarang Pusat</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,400..700&display=swap"
    rel="stylesheet">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: 'Roboto Flex', sans-serif;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-center">


  <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg">
    <header class="text-center mb-10">
      <h1 class="text-2xl font-bold">Ujian SMAN 2 Cikarang Pusat</h1>
      <p class="text-gray-700">Moving For Bright Future</p>
      <p class="text-red-600 font-semibold">Prototype</p>
    </header>

    <form id="loginForm" class="space-y-6">

      <!-- NIS input with floating label -->
      <!-- Name preview for the entered exam ID -->
      <div id="nisName" class="text-sm text-gray-600 mt-1 mb-2 min-h-[1.2em]"></div>

      <div class="relative z-0 w-full">
        <input type="text" name="ID" required placeholder=" "
          class="peer block w-full border-b-2 border-gray-300 bg-transparent px-0 py-2 text-gray-900 focus:border-blue-500 focus:outline-none focus:ring-0 transition-all duration-300" />
        <label
          class="absolute left-0 -top-3.5 text-gray-500 text-sm transition-all peer-placeholder-shown:top-2.5 peer-placeholder-shown:text-gray-400 peer-placeholder-shown:text-base peer-focus:-top-3.5 peer-focus:text-gray-700 peer-focus:text-sm">
          ID Ujian
        </label>
      </div>

      <!-- Message placeholder -->
      <div id="formMessage" role="alert" aria-live="polite" class="min-h-[1.2em] text-sm mt-1 mb-1"></div>

      <!-- Submit button -->
      <button type="submit"
        class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-1 transition-all duration-200">
        Mulai
      </button>
    </form>
  </div>

  <footer class="text-center mt-10 text-gray-600">
    <p>Hak Cipta Â© 2025 SMAN 2 Cikarang Pusat</p>
    <p>Karya Siswa Kelas 11</p>
  </footer>

  <script>
    // --- Check exam ID (NIS) when user finishes typing or presses Enter ---
    (function () {
      const idInput = document.querySelector('input[name="ID"]');
      const nisNameEl = document.getElementById('nisName');
      let debounceTimer = null;

      if (!idInput) return;

      const setIDName = (name) => {
        if (!nisNameEl) return;
        nisNameEl.textContent = name ? `Halo, ${name}` : '';
      };

      const checkID = async (examId) => {
        if (!examId) {
          setIDName('');
          return;
        }

        // show a small loading hint
        setIDName('Mengecek...');

        try {
          const resp = await fetch('./whoami', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ exam_id: examId }),
          });

          // try to parse JSON even on non-200 so we can show message if provided
          const data = await resp.json().catch(() => ({}));

          if (data && data.name) {
            setIDName(data.name);
            // store preview name locally so submit handler can use it later if needed
            try { localStorage.setItem('student-name-preview', data.name); } catch (e) { /* ignore */ }
          } else {
            // clear if no name returned
            setIDName('');
          }
        } catch (err) {
          // network or server error
          setIDName('Gagal mengecek ID (server offline)');
        }
      };

      // debounce helper: call checkID 400ms after typing stops
      idInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        const v = e.target.value && e.target.value.trim();
        debounceTimer = setTimeout(() => checkID(v), 700);
      });

      // also check on blur (user finished) and on Enter key
      idInput.addEventListener('blur', (e) => checkID(e.target.value && e.target.value.trim()));
    })();

    const form = document.getElementById('loginForm');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submit = form.querySelector('[type="submit"]');
      if (submit) submit.disabled = true;

      const messageEl = document.getElementById('formMessage');
      const setMessage = (msg, type) => {
        if (!messageEl) return;
        messageEl.textContent = msg || '';
        messageEl.className = 'min-h-[1.2em] text-sm mt-1 mb-1'; // reset
        if (!msg) return;
        if (type === 'error') {
          messageEl.classList.add('text-red-700', 'bg-red-100', 'p-2', 'rounded-md');
        } else if (type === 'success') {
          messageEl.classList.add('text-green-700', 'bg-green-100', 'p-2', 'rounded-md');
        }
      };

      setMessage('', '');

      try {
        const nis = form.querySelector('input[name="nis"]')?.value || '';
        const payload = { nis };

        const resp = await fetch('./', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const data = await resp.json().catch(() => ({ message: 'Tidak ada respon.' }));
        setMessage(data.message || 'Tidak ada pesan', resp.ok ? 'success' : 'error');

        if (resp.ok) {
          // store each parameter individually
          localStorage.setItem('student-hash', data.hash);
          localStorage.setItem('student-name', data.name);
          localStorage.setItem('student-special-key', data['special-key']); // dash needs bracket notation

          const params = new URLSearchParams(window.location.search);
          setTimeout(() => window.location.href = './exam', 500);
        }
      } catch (err) {
        const msg = err.message.includes('NetworkError')
          ? 'Server sedang offline'
          : 'Server error: ' + err.message;
        setMessage(msg, 'error');
      } finally {
        if (submit) submit.disabled = false;
      }

    });
  </script>

</body>

</html>